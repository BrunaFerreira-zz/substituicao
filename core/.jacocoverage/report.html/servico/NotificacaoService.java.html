<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>NotificacaoService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="right"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;core&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.html" class="el_package">servico</a> &gt; <span class="el_source">NotificacaoService.java</span></div><h1>NotificacaoService.java</h1><pre class="source lang-java linenums">/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package servico;

import datamapper.AusenciaJpaController;
import datamapper.ProfessorJpaController;
import datamapper.exceptions.NonexistentEntityException;
import dominio.Ausencia;
import dominio.EstadoAusencia;
import dominio.Professor;
import modelo.AusenciaModel;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.LinkedList;
import java.util.List;
import java.util.Random;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;
import org.joda.time.DateTime;
import org.joda.time.Interval;

/**
 *
 * @author Thiago Lima
 */
public class NotificacaoService {
    
    private AusenciaJpaController ausenciaController;
    private ProfessorJpaController profController;
    
<span class="fc" id="L36">    public NotificacaoService(){</span>
<span class="fc" id="L37">        EntityManagerFactory emf = Persistence.createEntityManagerFactory(&quot;pro_subPU&quot;);</span>
<span class="fc" id="L38">        ausenciaController = new AusenciaJpaController(emf);</span>
//        periodoController = new PeriodoJpaController(emf);
<span class="fc" id="L40">        profController = new ProfessorJpaController(emf);</span>
<span class="fc" id="L41">    }</span>
    
    public String notificarAusencia(Long idProfessor, String dataInicio, String dataFim, String motivo, List&lt;String&gt; nomesProfessoresIndicados) throws ParseException {
        
<span class="fc" id="L45">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
        
        
<span class="fc" id="L48">        DateTime inicio = new DateTime(sdf.parse(dataInicio));</span>
<span class="fc" id="L49">        DateTime inícioReal = new DateTime(inicio.getYear(),inicio.getMonthOfYear(),inicio.getDayOfMonth(),00,00);</span>
        
<span class="fc" id="L51">        DateTime fim = new DateTime(sdf.parse(dataFim));</span>
<span class="fc" id="L52">        DateTime fimReal = new DateTime(fim.getYear(),fim.getMonthOfYear(),fim.getDayOfMonth(),23,59);</span>
        
<span class="fc" id="L54">        Interval periodo = new Interval(inícioReal, fimReal);</span>
        
<span class="fc" id="L56">        Professor professor = profController.findProfessor(idProfessor);</span>
<span class="fc" id="L57">        List&lt;Professor&gt; professoresIndicados = new ArrayList&lt;Professor&gt;();</span>
        
        //Professor professorSubstituto = profController.findProfessor(idProfessorSubstituto);
        
<span class="fc" id="L61">        Random r = new Random();</span>
               
<span class="fc" id="L63">        List&lt;Ausencia&gt; ausencias = professor.gerarAusencias(periodo, motivo);</span>
        
<span class="fc" id="L65">        List&lt;String&gt; codigos = new LinkedList&lt;String&gt;();</span>
        
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for(Ausencia ausencia : ausencias)</span>
        {
<span class="fc" id="L69">            String codigo = Integer.toString(r.nextInt(10000));</span>
            
<span class="fc" id="L71">            ausencia.setCodigo(codigo);</span>
            
<span class="fc" id="L73">            codigos.add(codigo);</span>
            
<span class="fc bfc" id="L75" title="All 2 branches covered.">            for(String nomeProf : nomesProfessoresIndicados){</span>
<span class="fc" id="L76">                Professor professorIndicado = profController.findProfessor(nomeProf);</span>
<span class="fc" id="L77">                ausencia.indicarSubstituto(professorIndicado);</span>
<span class="fc" id="L78">            }</span>

<span class="fc" id="L80">            ausenciaController.create(ausencia);</span>
<span class="fc" id="L81">        }</span>
        
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if(codigos.size() &gt; 0)</span>
<span class="fc" id="L84">            return codigos.get(0);       </span>
        else
<span class="fc" id="L86">            return &quot;0&quot;;</span>
    }

//    public void editarAusencia(String codigo, String dataInicio, String dataFim, String motivo, Long idSubstituto) throws ParseException, NonexistentEntityException, Exception {
//        
//        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);
//        
//        DateTime inicio = new DateTime(sdf.parse(dataInicio));
//        DateTime fim = new DateTime(sdf.parse(dataFim));
//        
//        Interval periodo = new Interval(inicio, fim);
//        
//        Professor professorSubstituto = profController.findProfessor(idSubstituto);
//        
//        Random r = new Random();
//        
//        Ausencia ausencia = ausenciaController.findAusencia(codigo);
//        ausencia.setPeriodo(periodo);
//        ausencia.setMotivo(motivo);
//        ausencia.indicarSubstituto(professorSubstituto);
//                
//        ausenciaController.edit(ausencia);
//    }

    public List&lt;AusenciaModel&gt; listarAusencias() {
        
<span class="fc" id="L112">        List&lt;Ausencia&gt; ausencias = ausenciaController.findAusenciaEntities();</span>
<span class="fc" id="L113">        List&lt;AusenciaModel&gt; modelos = new LinkedList&lt;AusenciaModel&gt;();</span>
        
<span class="fc bfc" id="L115" title="All 2 branches covered.">        for(Ausencia ausencia : ausencias){</span>
            
<span class="fc" id="L117">            AusenciaModel modelo = this.montarAusencia(ausencia);</span>
            
<span class="fc" id="L119">            modelos.add(modelo);</span>
<span class="fc" id="L120">        }</span>
        
<span class="fc" id="L122">        return modelos;</span>
    }
    
    private String determinarEstado(EstadoAusencia estado){
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">        if(estado == EstadoAusencia.Ausencia_Cancelada)</span>
<span class="nc" id="L127">            return &quot;Ausência cancelada&quot;;</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        else if(estado == EstadoAusencia.Alocacao_Efetuada)</span>
<span class="nc" id="L129">            return &quot;Alocação efetuada&quot;;</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        else if(estado == EstadoAusencia.Alocacao_Pendente)</span>
<span class="fc" id="L131">            return &quot;Alocação pendente&quot;;</span>
        else{
<span class="nc" id="L133">            return &quot;Aulas canceladas&quot;;</span>
        }
    }
    
    public List&lt;AusenciaModel&gt; listarAusenciasPorEstado(EstadoAusencia estado){
        
<span class="nc" id="L139">        List&lt;Ausencia&gt; ausencias = ausenciaController.findAusenciaEntities();</span>
<span class="nc" id="L140">        List&lt;AusenciaModel&gt; modelos = new ArrayList&lt;AusenciaModel&gt;();</span>
        
<span class="nc bnc" id="L142" title="All 2 branches missed.">        for(Ausencia ausencia : ausencias){</span>
            
<span class="nc bnc" id="L144" title="All 2 branches missed.">            if(ausencia.getEstado().equals(estado)){</span>
<span class="nc" id="L145">                AusenciaModel modelo = this.montarAusencia(ausencia);</span>
                
<span class="nc" id="L147">                modelos.add(modelo);   </span>
            }               
<span class="nc" id="L149">        }            </span>
<span class="nc" id="L150">        return modelos;   </span>
    }
    
    public List&lt;AusenciaModel&gt; listarAusenciasPorProfessor(String usernameProfessor){
        
<span class="nc" id="L155">        Professor professor = profController.findProfessorPorUsername(usernameProfessor);</span>
        
<span class="nc" id="L157">        List&lt;Ausencia&gt; ausenciasPorProfessor = ausenciaController.listAusenciasPorProfessor(professor);</span>
        
<span class="nc" id="L159">        List&lt;AusenciaModel&gt; modelos = new ArrayList&lt;AusenciaModel&gt;();</span>
        
<span class="nc bnc" id="L161" title="All 2 branches missed.">        for(Ausencia ausencia : ausenciasPorProfessor){</span>
            
<span class="nc" id="L163">            AusenciaModel modelo = this.montarAusencia(ausencia);</span>
            
<span class="nc" id="L165">            modelos.add(modelo);</span>
            
<span class="nc" id="L167">        }</span>
        
<span class="nc" id="L169">        return modelos;</span>
    }
    
    public List&lt;AusenciaModel&gt; listarAusenciasPorIndicacaoDeSubstituto(String usernameProfessor){
        
<span class="nc" id="L174">        Professor professorIndicado = profController.findProfessorPorUsername(usernameProfessor);</span>
        
<span class="nc" id="L176">        List&lt;Ausencia&gt; ausenciasComIndicacaoDeSubstituto = ausenciaController.listAusenciasPorIndicacaoDeSubstituto(professorIndicado);</span>
        
<span class="nc" id="L178">        List&lt;AusenciaModel&gt; modelos = new ArrayList&lt;AusenciaModel&gt;();</span>
        
<span class="nc bnc" id="L180" title="All 2 branches missed.">        for(Ausencia ausencia : ausenciasComIndicacaoDeSubstituto){</span>
            
<span class="nc" id="L182">            AusenciaModel modelo = this.montarAusencia(ausencia);</span>
            
<span class="nc" id="L184">            modelos.add(modelo);</span>
            
<span class="nc" id="L186">        }</span>
        
<span class="nc" id="L188">        return modelos;</span>
    }
    
    
    
    private AusenciaModel montarAusencia(Ausencia ausencia){

<span class="fc" id="L195">        AusenciaModel modelo = new AusenciaModel();</span>

<span class="fc" id="L197">        modelo.codigo = ausencia.getCodigo();</span>
<span class="fc" id="L198">        modelo.professorAusente = ausencia.getProfessor().getNome();</span>
        
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        if(ausencia.getProfessorSubstituto() != null){</span>
<span class="nc" id="L201">            modelo.professorSubstituto = ausencia.getProfessorSubstituto().getNome();    </span>
        }else{
<span class="fc" id="L203">            modelo.professorSubstituto = &quot;&quot;;</span>
        }
        
        //modelo.professorSubstituto = ausencia.getIndicacoesSubstitutos().getNome();
<span class="fc" id="L207">        modelo.estado = this.determinarEstado(ausencia.getEstado());</span>
<span class="fc" id="L208">        modelo.id = ausencia.getId();</span>
<span class="fc" id="L209">        SimpleDateFormat sdf = new SimpleDateFormat(&quot;dd/MM/yyyy&quot;);</span>
<span class="fc" id="L210">        Interval periodo = ausencia.getPeriodo();</span>
<span class="fc" id="L211">        modelo.dataInicio = sdf.format(periodo.getStart().toDate());</span>
<span class="fc" id="L212">        modelo.dataFim = sdf.format(periodo.getEnd().toDate());</span>
        
<span class="fc" id="L214">        return modelo;</span>
        
    }

    public void definirSubstituto(String codigo, String nomeProfessor) {
        
<span class="fc" id="L220">        Professor profSubstituto = profController.findProfessor(nomeProfessor);</span>

<span class="fc bfc" id="L222" title="All 2 branches covered.">        if(profSubstituto == null){</span>
<span class="fc" id="L223">            throw new IllegalStateException(&quot;Professor de nome &quot; + nomeProfessor + &quot; não existe&quot;);</span>
        }
        
<span class="fc" id="L226">        Ausencia ausencia = ausenciaController.findAusencia(codigo);</span>
        
        
<span class="fc bfc" id="L229" title="All 2 branches covered.">        if(ausencia == null){</span>
<span class="fc" id="L230">            throw new IllegalStateException(&quot;Ausência de código &quot; + codigo + &quot; não existe&quot;);</span>
        }        
        
<span class="fc" id="L233">        ausencia.setProfessorSubstituto(profSubstituto);</span>
<span class="fc" id="L234">        ausencia.definirComoAlocado();</span>
        
        
        try {
<span class="fc" id="L238">            ausenciaController.edit(ausencia);</span>
<span class="nc" id="L239">        } catch (NonexistentEntityException ex) {</span>
<span class="nc" id="L240">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L241">        } catch (Exception ex) {</span>
<span class="nc" id="L242">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="pc" id="L243">        }</span>

        
<span class="fc" id="L246">    }</span>
    
    public void cancelarAusencia(String codigo){
        
<span class="fc" id="L250">        Ausencia ausencia = ausenciaController.findAusencia(codigo);</span>
        
<span class="fc" id="L252">        ausencia.cancelarAusencia();</span>
        try {
<span class="fc" id="L254">            ausenciaController.edit(ausencia);</span>
<span class="nc" id="L255">        } catch (NonexistentEntityException ex) {</span>
<span class="nc" id="L256">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L257">        } catch (Exception ex) {</span>
<span class="nc" id="L258">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="pc" id="L259">        }</span>
        
<span class="fc" id="L261">    }</span>
    
    public void cancelarAulas(String codigo){
        
<span class="fc" id="L265">        Ausencia ausencia = ausenciaController.findAusencia(codigo);</span>
        
<span class="fc" id="L267">        ausencia.cancelarAulas();</span>
        try {
<span class="fc" id="L269">            ausenciaController.edit(ausencia);</span>
<span class="nc" id="L270">        } catch (NonexistentEntityException ex) {</span>
<span class="nc" id="L271">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L272">        } catch (Exception ex) {</span>
<span class="nc" id="L273">            Logger.getLogger(NotificacaoService.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="pc" id="L274">        }</span>
        
<span class="fc" id="L276">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.6.3.201306030806</span></div></body></html>